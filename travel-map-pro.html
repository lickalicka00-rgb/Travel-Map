<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç Moja Putovanja</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 50%, #0d1520 100%);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Layout */
    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      background: rgba(15, 23, 42, 0.95);
      border-right: 1px solid rgba(255,255,255,0.06);
      padding: 20px;
      overflow-y: auto;
      max-height: 100vh;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .tagline {
      font-size: 0.8rem;
      opacity: 0.5;
      margin-bottom: 24px;
    }
    
    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    .search-input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: #e2e8f0;
      font-size: 0.9rem;
      outline: none;
      transition: all 0.2s;
    }
    .search-input:focus {
      border-color: #60a5fa;
      background: rgba(255,255,255,0.08);
    }
    .search-input::placeholder { color: rgba(255,255,255,0.3); }
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .search-results.active { display: block; }
    .search-result-item {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      transition: background 0.15s;
    }
    .search-result-item:hover { background: rgba(255,255,255,0.05); }
    .search-result-item .flag { font-size: 1.1rem; }
    .search-result-item .status {
      margin-left: auto;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .search-result-item .status.visited {
      background: rgba(34,197,94,0.2);
      color: #4ade80;
    }
    .search-result-item .status.bucket {
      background: rgba(251,191,36,0.2);
      color: #fbbf24;
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    .stat-card.highlight {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
      border-color: rgba(34,197,94,0.2);
    }
    .stat-card.bucket-highlight {
      background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(251,191,36,0.05));
      border-color: rgba(251,191,36,0.2);
    }
    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .stat-card.highlight .stat-number { color: #4ade80; }
    .stat-card.bucket-highlight .stat-number { color: #fbbf24; }
    .stat-label {
      font-size: 0.7rem;
      opacity: 0.6;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 2px;
    }
    
    /* Progress */
    .progress-section { margin-bottom: 24px; }
    .progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 8px;
    }
    .progress-bar {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      height: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    /* Achievements */
    .section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.5;
      margin-bottom: 12px;
    }
    .achievements {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }
    .achievement {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      opacity: 0.3;
      cursor: help;
      transition: all 0.2s;
    }
    .achievement.unlocked {
      opacity: 1;
      background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(251,191,36,0.05));
      border-color: rgba(251,191,36,0.3);
      box-shadow: 0 0 15px rgba(251,191,36,0.2);
    }
    .achievement:hover { transform: scale(1.1); }
    
    /* Continent Stats */
    .continent-stats { margin-bottom: 24px; }
    .continent-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 0.85rem;
    }
    .continent-item:last-child { border-bottom: none; }
    .continent-icon { font-size: 1rem; }
    .continent-name { flex: 1; }
    .continent-progress {
      width: 60px;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    .continent-progress-fill {
      height: 100%;
      background: #4ade80;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .continent-count {
      font-size: 0.75rem;
      opacity: 0.6;
      min-width: 45px;
      text-align: right;
    }
    
    /* Mode Toggle */
    .mode-toggle {
      display: flex;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 20px;
    }
    .mode-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 0.8rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-btn.active {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    .mode-btn.active.visited-mode { color: #4ade80; }
    .mode-btn.active.bucket-mode { color: #fbbf24; }
    
    /* Main Content */
    .main-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .hover-info {
      font-size: 1.1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .hover-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .hover-badge.visited {
      background: rgba(34,197,94,0.2);
      border: 1px solid rgba(34,197,94,0.3);
    }
    .hover-badge.bucket {
      background: rgba(251,191,36,0.2);
      border: 1px solid rgba(251,191,36,0.3);
    }
    .controls {
      display: flex;
      gap: 8px;
    }
    .control-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: #e2e8f0;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .control-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }
    
    /* Map */
    .map-container {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.06);
    }
    #map-svg {
      width: 100%;
      height: 100%;
      cursor: grab;
    }
    #map-svg:active { cursor: grabbing; }
    .country {
      transition: fill 0.15s;
    }
    .country:hover {
      filter: brightness(1.3);
    }
    .country-label {
      font-size: 8px;
      fill: rgba(255,255,255,0.7);
      pointer-events: none;
      text-anchor: middle;
      font-weight: 500;
    }
    .country-label.small {
      font-size: 6px;
    }
    
    /* Zoom indicator */
    .zoom-indicator {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: rgba(0,0,0,0.6);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.75rem;
      opacity: 0.7;
    }
    
    /* Legend */
    .legend {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0,0,0,0.6);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.75rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .legend-item:last-child { margin-bottom: 0; }
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .legend-color.visited { background: #2e7d32; }
    .legend-color.bucket { background: #b45309; }
    .legend-color.unvisited { background: #3a4a5a; }
    
    /* Loading */
    .loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(10,15,26,0.95);
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Tooltip */
    .tooltip {
      position: fixed;
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 0.85rem;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 200px;
    }
    .tooltip-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .tooltip-info {
      font-size: 0.75rem;
      opacity: 0.6;
    }
    
    /* Actions panel */
    .actions-panel {
      margin-top: 16px;
      display: flex;
      gap: 10px;
    }
    .action-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03);
      color: #e2e8f0;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .action-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.2);
    }
    .action-btn.danger {
      border-color: rgba(239,68,68,0.3);
      color: #f87171;
    }
    .action-btn.danger:hover {
      background: rgba(239,68,68,0.1);
    }
    
    /* Responsive */
    @media (max-width: 900px) {
      .app-container {
        grid-template-columns: 1fr;
      }
      .sidebar {
        max-height: none;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }
      .map-container {
        min-height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">üåç Moja Putovanja</div>
      <div class="tagline">Prati gde si sve bio</div>
      
      <!-- Search -->
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" id="search" placeholder="Pretra≈æi zemlje..." autocomplete="off">
        <div class="search-results" id="search-results"></div>
      </div>
      
      <!-- Mode Toggle -->
      <div class="mode-toggle">
        <button class="mode-btn visited-mode active" data-mode="visited" onclick="setMode('visited')">
          ‚úì Poseƒáeno
        </button>
        <button class="mode-btn bucket-mode" data-mode="bucket" onclick="setMode('bucket')">
          ‚òÖ Bucket List
        </button>
      </div>
      
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card highlight">
          <div class="stat-number" id="visited-count">0</div>
          <div class="stat-label">Poseƒáeno</div>
        </div>
        <div class="stat-card bucket-highlight">
          <div class="stat-number" id="bucket-count">0</div>
          <div class="stat-label">Bucket List</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-count">0</div>
          <div class="stat-label">Ukupno</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="percent">0%</div>
          <div class="stat-label">Sveta</div>
        </div>
      </div>
      
      <!-- Progress -->
      <div class="progress-section">
        <div class="progress-header">
          <span>Napredak</span>
          <span id="progress-text">0 / 0</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress"></div>
        </div>
      </div>
      
      <!-- Achievements -->
      <div class="section-title">Dostignuƒáa</div>
      <div class="achievements" id="achievements">
        <div class="achievement" data-achievement="first" title="Prvo putovanje">üéí</div>
        <div class="achievement" data-achievement="five" title="5 dr≈æava">üåü</div>
        <div class="achievement" data-achievement="ten" title="10 dr≈æava">üèÜ</div>
        <div class="achievement" data-achievement="twenty" title="20 dr≈æava">üéØ</div>
        <div class="achievement" data-achievement="fifty" title="50 dr≈æava">üëë</div>
        <div class="achievement" data-achievement="hundred" title="100 dr≈æava">üåç</div>
        <div class="achievement" data-achievement="europe" title="Cela Evropa">üá™üá∫</div>
        <div class="achievement" data-achievement="asia" title="Cela Azija">üêâ</div>
        <div class="achievement" data-achievement="americas" title="Obe Amerike">üóΩ</div>
        <div class="achievement" data-achievement="africa" title="Cela Afrika">ü¶Å</div>
        <div class="achievement" data-achievement="oceania" title="Okeanija">üèùÔ∏è</div>
        <div class="achievement" data-achievement="world" title="Ceo svet!">üöÄ</div>
      </div>
      
      <!-- Continent Stats -->
      <div class="section-title">Po kontinentima</div>
      <div class="continent-stats" id="continent-stats"></div>
      
      <!-- Actions -->
      <div class="actions-panel">
        <button class="action-btn" onclick="exportData()">
          üì§ Export
        </button>
        <button class="action-btn" onclick="importData()">
          üì• Import
        </button>
        <button class="action-btn danger" onclick="resetAll()">
          üóëÔ∏è
        </button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <div class="top-bar">
        <div class="hover-info" id="hover-info">
          <span style="opacity: 0.5">Hover over a country</span>
        </div>
        <div class="controls">
          <button class="control-btn" onclick="zoomIn()" title="Zoom In">+</button>
          <button class="control-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
          <button class="control-btn" onclick="resetZoom()" title="Reset">‚ü≤</button>
          <button class="control-btn" onclick="toggleLabels()" title="Toggle Labels" id="labels-btn">Aa</button>
        </div>
      </div>
      
      <div class="map-container" id="map-container">
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p style="margin-top: 16px; opacity: 0.6;">Uƒçitavam mapu sveta...</p>
        </div>
        <svg id="map-svg"></svg>
        <div class="zoom-indicator" id="zoom-indicator">Zoom: 100%</div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color visited"></div>
            <span>Poseƒáeno</span>
          </div>
          <div class="legend-item">
            <div class="legend-color bucket"></div>
            <span>Bucket List</span>
          </div>
          <div class="legend-item">
            <div class="legend-color unvisited"></div>
            <span>Neposeƒáeno</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="tooltip" id="tooltip" style="display: none;"></div>
  
  <input type="file" id="import-file" accept=".json" style="display: none;">

  <script>
    // Data
    const STORAGE_KEY = 'travel-map-data-v5';
    let visited = new Set();
    let bucketList = new Set();
    let countryData = {};
    let countryContinents = {};
    let currentMode = 'visited'; // 'visited' or 'bucket'
    let showLabels = true;
    let svg, g, projection, path, zoom;
    
    // Continent definitions
    const continents = {
      'Europe': { icon: 'üá™üá∫', countries: [] },
      'Asia': { icon: 'üåè', countries: [] },
      'Africa': { icon: 'üåç', countries: [] },
      'North America': { icon: 'üåé', countries: [] },
      'South America': { icon: 'üåé', countries: [] },
      'Oceania': { icon: 'üèùÔ∏è', countries: [] }
    };
    
    // Country to continent mapping (approximate based on common classifications)
    const countryToContinent = {
      // Europe
      'Albania': 'Europe', 'Andorra': 'Europe', 'Austria': 'Europe', 'Belarus': 'Europe',
      'Belgium': 'Europe', 'Bosnia and Herz.': 'Europe', 'Bulgaria': 'Europe', 'Croatia': 'Europe',
      'Cyprus': 'Europe', 'Czechia': 'Europe', 'Denmark': 'Europe', 'Estonia': 'Europe',
      'Finland': 'Europe', 'France': 'Europe', 'Germany': 'Europe', 'Greece': 'Europe',
      'Hungary': 'Europe', 'Iceland': 'Europe', 'Ireland': 'Europe', 'Italy': 'Europe',
      'Kosovo': 'Europe', 'Latvia': 'Europe', 'Liechtenstein': 'Europe', 'Lithuania': 'Europe',
      'Luxembourg': 'Europe', 'Malta': 'Europe', 'Moldova': 'Europe', 'Monaco': 'Europe',
      'Montenegro': 'Europe', 'Netherlands': 'Europe', 'North Macedonia': 'Europe', 'Norway': 'Europe',
      'Poland': 'Europe', 'Portugal': 'Europe', 'Romania': 'Europe', 'Russia': 'Europe',
      'San Marino': 'Europe', 'Serbia': 'Europe', 'Slovakia': 'Europe', 'Slovenia': 'Europe',
      'Spain': 'Europe', 'Sweden': 'Europe', 'Switzerland': 'Europe', 'Ukraine': 'Europe',
      'United Kingdom': 'Europe', 'Vatican': 'Europe',
      // Asia
      'Afghanistan': 'Asia', 'Armenia': 'Asia', 'Azerbaijan': 'Asia', 'Bahrain': 'Asia',
      'Bangladesh': 'Asia', 'Bhutan': 'Asia', 'Brunei': 'Asia', 'Cambodia': 'Asia',
      'China': 'Asia', 'Georgia': 'Asia', 'India': 'Asia', 'Indonesia': 'Asia',
      'Iran': 'Asia', 'Iraq': 'Asia', 'Israel': 'Asia', 'Japan': 'Asia',
      'Jordan': 'Asia', 'Kazakhstan': 'Asia', 'Kuwait': 'Asia', 'Kyrgyzstan': 'Asia',
      'Laos': 'Asia', 'Lebanon': 'Asia', 'Malaysia': 'Asia', 'Maldives': 'Asia',
      'Mongolia': 'Asia', 'Myanmar': 'Asia', 'Nepal': 'Asia', 'North Korea': 'Asia',
      'Oman': 'Asia', 'Pakistan': 'Asia', 'Palestine': 'Asia', 'Philippines': 'Asia',
      'Qatar': 'Asia', 'Saudi Arabia': 'Asia', 'Singapore': 'Asia', 'South Korea': 'Asia',
      'Sri Lanka': 'Asia', 'Syria': 'Asia', 'Taiwan': 'Asia', 'Tajikistan': 'Asia',
      'Thailand': 'Asia', 'Timor-Leste': 'Asia', 'Turkey': 'Asia', 'Turkmenistan': 'Asia',
      'United Arab Emirates': 'Asia', 'Uzbekistan': 'Asia', 'Vietnam': 'Asia', 'Yemen': 'Asia',
      // Africa
      'Algeria': 'Africa', 'Angola': 'Africa', 'Benin': 'Africa', 'Botswana': 'Africa',
      'Burkina Faso': 'Africa', 'Burundi': 'Africa', 'Cameroon': 'Africa', 'Cape Verde': 'Africa',
      'Central African Rep.': 'Africa', 'Chad': 'Africa', 'Comoros': 'Africa', 'Congo': 'Africa',
      'Dem. Rep. Congo': 'Africa', "C√¥te d'Ivoire": 'Africa', 'Djibouti': 'Africa', 'Egypt': 'Africa',
      'Eq. Guinea': 'Africa', 'Eritrea': 'Africa', 'eSwatini': 'Africa', 'Ethiopia': 'Africa',
      'Gabon': 'Africa', 'Gambia': 'Africa', 'Ghana': 'Africa', 'Guinea': 'Africa',
      'Guinea-Bissau': 'Africa', 'Kenya': 'Africa', 'Lesotho': 'Africa', 'Liberia': 'Africa',
      'Libya': 'Africa', 'Madagascar': 'Africa', 'Malawi': 'Africa', 'Mali': 'Africa',
      'Mauritania': 'Africa', 'Mauritius': 'Africa', 'Morocco': 'Africa', 'Mozambique': 'Africa',
      'Namibia': 'Africa', 'Niger': 'Africa', 'Nigeria': 'Africa', 'Rwanda': 'Africa',
      'S√£o Tom√© and Principe': 'Africa', 'Senegal': 'Africa', 'Seychelles': 'Africa', 'Sierra Leone': 'Africa',
      'Somalia': 'Africa', 'South Africa': 'Africa', 'South Sudan': 'Africa', 'Sudan': 'Africa',
      'Tanzania': 'Africa', 'Togo': 'Africa', 'Tunisia': 'Africa', 'Uganda': 'Africa',
      'Zambia': 'Africa', 'Zimbabwe': 'Africa', 'W. Sahara': 'Africa', 'Somaliland': 'Africa',
      // North America
      'Antigua and Barbuda': 'North America', 'Bahamas': 'North America', 'Barbados': 'North America',
      'Belize': 'North America', 'Canada': 'North America', 'Costa Rica': 'North America',
      'Cuba': 'North America', 'Dominica': 'North America', 'Dominican Rep.': 'North America',
      'El Salvador': 'North America', 'Grenada': 'North America', 'Guatemala': 'North America',
      'Haiti': 'North America', 'Honduras': 'North America', 'Jamaica': 'North America',
      'Mexico': 'North America', 'Nicaragua': 'North America', 'Panama': 'North America',
      'Puerto Rico': 'North America', 'Saint Kitts and Nevis': 'North America', 'Saint Lucia': 'North America',
      'Saint Vincent and the Grenadines': 'North America', 'Trinidad and Tobago': 'North America',
      'United States of America': 'North America', 'United States': 'North America',
      // South America
      'Argentina': 'South America', 'Bolivia': 'South America', 'Brazil': 'South America',
      'Chile': 'South America', 'Colombia': 'South America', 'Ecuador': 'South America',
      'Guyana': 'South America', 'Paraguay': 'South America', 'Peru': 'South America',
      'Suriname': 'South America', 'Uruguay': 'South America', 'Venezuela': 'South America',
      'Falkland Is.': 'South America', 'Fr. S. Antarctic Lands': 'South America',
      // Oceania
      'Australia': 'Oceania', 'Fiji': 'Oceania', 'Kiribati': 'Oceania', 'Marshall Islands': 'Oceania',
      'Micronesia': 'Oceania', 'Nauru': 'Oceania', 'New Zealand': 'Oceania', 'Palau': 'Oceania',
      'Papua New Guinea': 'Oceania', 'Samoa': 'Oceania', 'Solomon Is.': 'Oceania', 'Tonga': 'Oceania',
      'Tuvalu': 'Oceania', 'Vanuatu': 'Oceania', 'New Caledonia': 'Oceania'
    };
    
    // Load data from localStorage
    function loadData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          visited = new Set(data.visited || []);
          bucketList = new Set(data.bucketList || []);
        }
      } catch (e) {
        console.log('No saved data');
      }
    }
    
    // Save data to localStorage
    function saveData() {
      try {
        const data = {
          visited: [...visited],
          bucketList: [...bucketList]
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Save failed:', e);
      }
    }
    
    // Set mode
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
    }
    
    // Toggle country
    function toggleCountry(id) {
      const targetSet = currentMode === 'visited' ? visited : bucketList;
      const otherSet = currentMode === 'visited' ? bucketList : visited;
      
      if (targetSet.has(id)) {
        targetSet.delete(id);
      } else {
        targetSet.add(id);
        otherSet.delete(id); // Remove from other set
      }
      
      saveData();
      updateMap();
      updateStats();
      updateAchievements();
    }
    
    // Get country color
    function getCountryColor(id) {
      if (visited.has(id)) return '#2e7d32';
      if (bucketList.has(id)) return '#b45309';
      return '#3a4a5a';
    }
    
    // Get country stroke
    function getCountryStroke(id) {
      if (visited.has(id)) return '#4caf50';
      if (bucketList.has(id)) return '#f59e0b';
      return '#4a5a6a';
    }
    
    // Update map colors
    function updateMap() {
      if (!svg) return;
      svg.selectAll('.country')
        .attr('fill', d => getCountryColor(d.id))
        .attr('stroke', d => getCountryStroke(d.id));
    }
    
    // Update statistics
    function updateStats() {
      const total = Object.keys(countryData).length;
      const visitedCount = visited.size;
      const bucketCount = bucketList.size;
      const pct = total > 0 ? ((visitedCount / total) * 100).toFixed(1) : 0;
      
      document.getElementById('visited-count').textContent = visitedCount;
      document.getElementById('bucket-count').textContent = bucketCount;
      document.getElementById('total-count').textContent = total;
      document.getElementById('percent').textContent = pct + '%';
      document.getElementById('progress').style.width = pct + '%';
      document.getElementById('progress-text').textContent = `${visitedCount} / ${total}`;
      
      // Update continent stats
      updateContinentStats();
    }
    
    // Update continent statistics
    function updateContinentStats() {
      const stats = {};
      Object.keys(continents).forEach(c => {
        stats[c] = { total: 0, visited: 0 };
      });
      
      Object.entries(countryData).forEach(([id, name]) => {
        const continent = countryToContinent[name];
        if (continent && stats[continent]) {
          stats[continent].total++;
          if (visited.has(id)) {
            stats[continent].visited++;
          }
        }
      });
      
      const container = document.getElementById('continent-stats');
      container.innerHTML = Object.entries(stats)
        .filter(([_, s]) => s.total > 0)
        .map(([name, s]) => {
          const pct = s.total > 0 ? (s.visited / s.total * 100) : 0;
          return `
            <div class="continent-item">
              <span class="continent-icon">${continents[name].icon}</span>
              <span class="continent-name">${name}</span>
              <div class="continent-progress">
                <div class="continent-progress-fill" style="width: ${pct}%"></div>
              </div>
              <span class="continent-count">${s.visited}/${s.total}</span>
            </div>
          `;
        }).join('');
    }
    
    // Update achievements
    function updateAchievements() {
      const count = visited.size;
      const achievements = {
        first: count >= 1,
        five: count >= 5,
        ten: count >= 10,
        twenty: count >= 20,
        fifty: count >= 50,
        hundred: count >= 100
      };
      
      // Check continent achievements
      const continentVisited = {};
      Object.keys(continents).forEach(c => continentVisited[c] = { total: 0, visited: 0 });
      
      Object.entries(countryData).forEach(([id, name]) => {
        const continent = countryToContinent[name];
        if (continent && continentVisited[continent]) {
          continentVisited[continent].total++;
          if (visited.has(id)) continentVisited[continent].visited++;
        }
      });
      
      achievements.europe = continentVisited['Europe'].total > 0 && 
        continentVisited['Europe'].visited >= continentVisited['Europe'].total * 0.9;
      achievements.asia = continentVisited['Asia'].total > 0 && 
        continentVisited['Asia'].visited >= continentVisited['Asia'].total * 0.9;
      achievements.americas = continentVisited['North America'].visited + continentVisited['South America'].visited >= 
        (continentVisited['North America'].total + continentVisited['South America'].total) * 0.9;
      achievements.africa = continentVisited['Africa'].total > 0 && 
        continentVisited['Africa'].visited >= continentVisited['Africa'].total * 0.9;
      achievements.oceania = continentVisited['Oceania'].total > 0 && 
        continentVisited['Oceania'].visited >= continentVisited['Oceania'].total * 0.9;
      achievements.world = count >= Object.keys(countryData).length * 0.9;
      
      // Update UI
      document.querySelectorAll('.achievement').forEach(el => {
        const key = el.dataset.achievement;
        el.classList.toggle('unlocked', achievements[key]);
      });
    }
    
    // Search functionality
    function setupSearch() {
      const input = document.getElementById('search');
      const results = document.getElementById('search-results');
      
      input.addEventListener('input', () => {
        const query = input.value.toLowerCase().trim();
        if (query.length < 2) {
          results.classList.remove('active');
          return;
        }
        
        const matches = Object.entries(countryData)
          .filter(([_, name]) => name.toLowerCase().includes(query))
          .slice(0, 8);
        
        if (matches.length === 0) {
          results.classList.remove('active');
          return;
        }
        
        results.innerHTML = matches.map(([id, name]) => {
          let status = '';
          if (visited.has(id)) status = '<span class="status visited">Poseƒáeno</span>';
          else if (bucketList.has(id)) status = '<span class="status bucket">Bucket</span>';
          return `
            <div class="search-result-item" data-id="${id}">
              <span class="name">${name}</span>
              ${status}
            </div>
          `;
        }).join('');
        
        results.classList.add('active');
        
        results.querySelectorAll('.search-result-item').forEach(item => {
          item.addEventListener('click', () => {
            const id = item.dataset.id;
            toggleCountry(id);
            input.value = '';
            results.classList.remove('active');
            // Flash the country on map
            highlightCountry(id);
          });
        });
      });
      
      input.addEventListener('blur', () => {
        setTimeout(() => results.classList.remove('active'), 200);
      });
    }
    
    // Highlight country on map
    function highlightCountry(id) {
      const country = svg.select(`.country[data-id="${id}"]`);
      if (!country.empty()) {
        country
          .transition().duration(200)
          .attr('stroke', '#fff')
          .attr('stroke-width', 3)
          .transition().duration(500)
          .attr('stroke', getCountryStroke(id))
          .attr('stroke-width', 0.5);
      }
    }
    
    // Zoom functions
    function zoomIn() {
      svg.transition().call(zoom.scaleBy, 1.5);
    }
    
    function zoomOut() {
      svg.transition().call(zoom.scaleBy, 0.67);
    }
    
    function resetZoom() {
      svg.transition().call(zoom.transform, d3.zoomIdentity);
    }
    
    // Toggle labels
    function toggleLabels() {
      showLabels = !showLabels;
      svg.selectAll('.country-label').style('display', showLabels ? 'block' : 'none');
      document.getElementById('labels-btn').style.opacity = showLabels ? 1 : 0.5;
    }
    
    // Export data
    function exportData() {
      const data = {
        visited: [...visited].map(id => countryData[id] || id),
        bucketList: [...bucketList].map(id => countryData[id] || id),
        exportDate: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'moja-putovanja.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Import data
    function importData() {
      document.getElementById('import-file').click();
    }
    
    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          // Convert names back to IDs
          const nameToId = {};
          Object.entries(countryData).forEach(([id, name]) => {
            nameToId[name] = id;
          });
          
          if (data.visited) {
            visited = new Set(data.visited.map(n => nameToId[n] || n).filter(Boolean));
          }
          if (data.bucketList) {
            bucketList = new Set(data.bucketList.map(n => nameToId[n] || n).filter(Boolean));
          }
          
          saveData();
          updateMap();
          updateStats();
          updateAchievements();
          alert('Podaci uspe≈°no importovani!');
        } catch (err) {
          alert('Gre≈°ka pri importu: ' + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });
    
    // Reset all
    function resetAll() {
      if (confirm('Da li si siguran da ≈æeli≈° da obri≈°e≈° sve podatke?')) {
        visited = new Set();
        bucketList = new Set();
        localStorage.removeItem(STORAGE_KEY);
        updateMap();
        updateStats();
        updateAchievements();
      }
    }
    
    // Show tooltip
    function showTooltip(event, d) {
      const name = countryData[d.id] || d.id;
      const continent = countryToContinent[name] || 'Unknown';
      let status = 'Neposeƒáeno';
      if (visited.has(d.id)) status = '‚úì Poseƒáeno';
      else if (bucketList.has(d.id)) status = '‚òÖ Bucket List';
      
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = `
        <div class="tooltip-name">${name}</div>
        <div class="tooltip-info">${continent} ‚Ä¢ ${status}</div>
      `;
      tooltip.style.display = 'block';
      tooltip.style.left = (event.pageX + 15) + 'px';
      tooltip.style.top = (event.pageY + 15) + 'px';
      
      // Update hover info
      document.getElementById('hover-info').innerHTML = `
        <span>${name}</span>
        ${visited.has(d.id) ? '<span class="hover-badge visited">‚úì Poseƒáeno</span>' : 
          bucketList.has(d.id) ? '<span class="hover-badge bucket">‚òÖ Bucket</span>' : ''}
      `;
    }
    
    function hideTooltip() {
      document.getElementById('tooltip').style.display = 'none';
      document.getElementById('hover-info').innerHTML = '<span style="opacity: 0.5">Hover over a country</span>';
    }
    
    // Initialize map
    async function initMap() {
      loadData();
      
      try {
        const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
        const world = await response.json();
        const countries = topojson.feature(world, world.objects.countries);
        
        // Build country data
        countries.features.forEach(f => {
          const name = f.properties?.name || `Country ${f.id}`;
          countryData[f.id] = name;
          countryContinents[f.id] = countryToContinent[name] || 'Unknown';
        });
        
        // Hide loading
        document.getElementById('loading').style.display = 'none';
        
        // Setup SVG
        const container = document.getElementById('map-container');
        const width = container.clientWidth;
        const height = container.clientHeight || 500;
        
        svg = d3.select('#map-svg')
          .attr('width', width)
          .attr('height', height);
        
        projection = d3.geoNaturalEarth1()
          .scale(width / 5.5)
          .translate([width / 2, height / 2]);
        
        path = d3.geoPath().projection(projection);
        
        // Setup zoom
        zoom = d3.zoom()
          .scaleExtent([1, 12])
          .on('zoom', (event) => {
            g.attr('transform', event.transform);
            document.getElementById('zoom-indicator').textContent = 
              `Zoom: ${Math.round(event.transform.k * 100)}%`;
            
            // Adjust label visibility based on zoom
            const scale = event.transform.k;
            svg.selectAll('.country-label')
              .style('font-size', `${Math.max(6, 8 / scale)}px`)
              .style('display', showLabels && scale > 1.5 ? 'block' : (showLabels && scale <= 1.5 ? 'block' : 'none'));
          });
        
        svg.call(zoom);
        
        // Create group for zoomable content
        g = svg.append('g');
        
        // Draw ocean
        g.append('rect')
          .attr('width', width * 3)
          .attr('height', height * 3)
          .attr('x', -width)
          .attr('y', -height)
          .attr('fill', '#1a2a3a');
        
        // Draw graticule
        const graticule = d3.geoGraticule();
        g.append('path')
          .datum(graticule())
          .attr('d', path)
          .attr('fill', 'none')
          .attr('stroke', 'rgba(255,255,255,0.04)')
          .attr('stroke-width', 0.5);
        
        // Draw countries
        g.selectAll('.country')
          .data(countries.features)
          .enter()
          .append('path')
          .attr('class', 'country')
          .attr('data-id', d => d.id)
          .attr('d', path)
          .attr('fill', d => getCountryColor(d.id))
          .attr('stroke', d => getCountryStroke(d.id))
          .attr('stroke-width', 0.5)
          .on('mouseenter', function(event, d) {
            showTooltip(event, d);
            d3.select(this).attr('stroke-width', 1.5).attr('stroke', '#ffc107');
          })
          .on('mousemove', function(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
          })
          .on('mouseleave', function(event, d) {
            hideTooltip();
            d3.select(this)
              .attr('stroke-width', 0.5)
              .attr('stroke', getCountryStroke(d.id));
          })
          .on('click', function(event, d) {
            toggleCountry(d.id);
          });
        
        // Add country labels
        g.selectAll('.country-label')
          .data(countries.features)
          .enter()
          .append('text')
          .attr('class', d => {
            const centroid = path.centroid(d);
            const bounds = path.bounds(d);
            const size = Math.abs(bounds[1][0] - bounds[0][0]);
            return 'country-label' + (size < 30 ? ' small' : '');
          })
          .attr('x', d => path.centroid(d)[0])
          .attr('y', d => path.centroid(d)[1])
          .text(d => {
            const name = countryData[d.id];
            // Abbreviate long names
            if (name === 'United States of America') return 'USA';
            if (name === 'United Kingdom') return 'UK';
            if (name === 'United Arab Emirates') return 'UAE';
            if (name === 'Central African Rep.') return 'CAR';
            if (name === 'Dem. Rep. Congo') return 'DRC';
            if (name === 'Dominican Rep.') return 'Dom. Rep.';
            if (name && name.length > 12) return name.substring(0, 10) + '...';
            return name;
          })
          .style('display', showLabels ? 'block' : 'none');
        
        // Setup search
        setupSearch();
        
        // Initial stats
        updateStats();
        updateAchievements();
        
      } catch (error) {
        console.error('Failed to load map:', error);
        document.getElementById('loading').innerHTML = `
          <div style="color: #ef4444; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <p>Gre≈°ka pri uƒçitavanju mape</p>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 8px;">${error.message}</p>
          </div>
        `;
      }
    }
    
    // Handle resize
    window.addEventListener('resize', () => {
      if (!svg) return;
      const container = document.getElementById('map-container');
      const width = container.clientWidth;
      const height = container.clientHeight || 500;
      svg.attr('width', width).attr('height', height);
    });
    
    // Start
    initMap();
  </script>
</body>
</html>
